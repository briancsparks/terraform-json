#!/bin/bash -e

readlink_f() { which greadlink > /dev/null && greadlink -f $1 || readlink -f $1; }
script_dir="$( cd "$(dirname "$( readlink_f "${BASH_SOURCE[0]}" )" )" && pwd )"

errcho() { echo "$@" 1>&2; }
die() { errcho "$@"; exit 1; }

curr_dir="$(pwd)"

mkdir -p build-tf && cd $_

node "${curr_dir}/$1" > ./intermediate.json
tfjson-to-tf-json-files ./intermediate.json

# Initialize terraform
if ! [[ -d .terraform ]]; then
  terraform init
fi

terraform validate && terraform apply
